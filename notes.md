# 这是一个笔记，关于学习SM2的  

**受限于我个人能力，笔记中必然会有谬误，请不吝赐教，在此先谢过**

## 基于椭圆曲线上的离散对数难题的非对称密码算法

### 什么是椭圆曲线？

#### 对椭圆曲线的向下解释

椭圆曲线方程：$y^2+axy+by = x^3+cx^2+dx+e$ 或简化为：$4y^2 = x^3+ax+b$  
这里的椭圆曲线是在**有限域上**的椭圆曲线  
**有限域**是啥？ 是一个带有有限阶数的**域**  
而**域**又是啥？是一个满足特定条件的**环**  
**环**呢？ 是两个**群**（交换群、半群）组合成的  
**群**呢？ 群是一个满足一定条件的**代数结构**  
一个非空集合在一种运算上是封闭的，那这种运算与这个集合就构成了一个**代数结构**

#### 到这算是解释完毕了，然后我们加入条件，向上还原

一个非空集合在一种运算上是封闭的，那这种运算与这个集合就构成了一个**代数结构**
**代数结构**满足*结合律*叫**半群**，在这基础上又满足*幺元律、逆元律、交换律*就叫**交换群**  
当两个**群**（集合相同）的*运算满足分配律*时，这两个群就组合成**环**  
当**环**中的**半群**去掉零元后可以*变成交换群*时，这个环升格成为**域**  
*有限阶数*后就变成了**有限域**  
**椭圆曲线**还是那个熟悉的函数，但因为*有限域的限制*，所以它变成了一个**点集**，且加上了一个mod(p)的步骤  
数学表示：$E_p(a,b) = \{ (x,y) | \equiv x^3 + ax + b (mod\ p),x,y \in Z_p\}\cup\{ O \}$  
（其实有限域上的椭圆曲线定义还有一个限制，就是$4a^3+26b^2 mod (p)$）  
麻烦是吗？但是，还记得我们说**有限域上的椭圆曲线是会被限制成为点集**吗？  
这个点集会构成一个**循环群**，而**无限远点O就是它的幺元**。  
所以真正和我们打交道的不过是**一个由点构成的循环群**罢了（bushi)  

#### SM2上的椭圆曲线

当我们碰到SM2时，情况**好像**又升级了  
两条椭圆曲线基于有两个有限域，一个叫素域（粟裕）一个叫扩域（蛞蝓）（md首选词没一个对的）

**素域**是没有真子域的有限域，**扩域**是某个子域的扩  
注意的是这里要求子域里面最底层的两个子群都必须还能一层层上来构成域  
但目前来看我还没有弄明白为什么要是这两种域……  
所以接下来是背书时间：  
《信息安全数学基础》中定义素域：

1. 若$p$是素数，$GF(p)=(Z_p,+_p,×_p)$只具有平凡子域，即$GF(p)$不含有任何真子域。一个没有任何真子域的域成为**素域**，也成为极小域，因为他不会是任何子域的扩域。
2. 若$p$是素数，$GF(p^n)$的子域，是$GF(p^n)$的最小的子域。
3. 有限域$F$的特征等于$F$的一个素域的阶。
4. 域$F$的所有子域的交是一个素域，$GF(p^n)$的素域为$GF(p)$。

### 椭圆曲线上的运算

因为这里只有有限域上的，因此我们**只讨论有限域上的情况**（其实实数域上的也差不多就是了）  
首先是关于零点（无限远点）的：$P+O=O+P=P$  
然后是关于负元的：$P$的负元是$-P(x,p-y)$（对p就是$E_p$的那个p），$P+-P = O$  
再后是加运算：$P(x_1,y_1)+Q(x_2,y_2) = R(x_3,y_3)$  
$x_3 = k^2-x_1-x_2(mod\ p),y_3=k(x_1-x_3)-y_1(mod\ p)$  
其中，$k= \frac{y_1-y_2}{x_1-x_2}(mod\ p) $  
**最后也是最重要**，倍点运算：运算公式就是加运算的公式，但$k= \frac{3x^2+a}{2y}(mod\ p)$

### 椭圆曲线上的N倍点

当点$Q=P+P+....+P$($n$个$P$相加)时，称$Q$为$P$的$n$倍点，记作$Q=[n]P$

### 椭圆曲线上的离散对数难题

当知道点$P$与其倍点$Q$之后，问：$Q$是$P$的几倍点？  
能否通过两点坐标直接计算倍数呢？答案是不能。  
唯一的方法是通过计算2倍点、3倍点...一步步上来，或者随机算撞大运，直到坐标相等。  
这样，倍点计算就构成了一个单向函数，逆向计算倍点数也就是椭圆曲线上的离散对数难题。  

到这基础就弄完了，下面开始正题SM2的内容：

## 数据类型

上面学了那么多，还没有开始接触算法...  
到数据类型这里我们距离SM2更近一步  
在GB/T 32918.1-2016中，一共有5中数据类型：比特串、字节串、整数、域元素、点

### 每种类型（不怎么）详细的 介绍

比特串：有序0 1序列  
字节串：有序字节序列  
整数：非负整数（无符号数）  
对于计算机专业的同学不需要解释就能弄懂

域元素：有限域$F_q$上的元素  
椭圆曲线上的点：椭圆曲线当然是那个被限制后的椭圆曲线，也就是说这个那个循环群的元素  
这两种特殊的数据类型实际上就是整数或者比特串，不过对于不同的有限域下的椭圆曲线有着不同的类型

### 数据类型间的转换

这个标题看似要写的内容较多，但我认为其根本在于**字节串与整数与比特串之间**的转换。  
这三种类型之间的转换想必得心应手，我们要做的只是了解其他类型到底是如何表示的就好。

首先是域元素，如果这个域是奇素数域，那么这个域元素就是在[1,q-1]区间中的整数；如果这个域是一个扩域（$2^m$），那么这个域元素就是一串比特串。
其次就是椭圆曲线上的点了，因为椭圆曲线上的点有三种表示方式，所以有三种不同的转换方式。时间有限，我将只学习无压缩表示方法。
无压缩表示方法：一个点(x，y)，其中x和y都是一个域元素，然后域元素的表示方式就十分清晰了。  
使用无压缩表示法的标识符为"04"，并连接上转换为字符串格式的x和y就是点的表示方法。  
即：$04|x|y$

## SM2算法

### 非对称

SM2作为非对称密码算法，应该有两种应用环境：

1. 作为非对称密码算法进行加密与解密  
2. 作为签名算法进行文件的签名与验签

在国标中，签名算法写在第二章中，而非对称密码算法写在第四章中，后文我按照国标顺序写。

### 辅助算法与参数

#### 椭圆曲线参数

这些在国标第五章有所规定(原文复制出来全是全角 /脑壳疼)  
素数$p$：FFFFFFFE FFFFFFFF FFFFFFFF FFFFFFFF FFFFFFFF 00000000 FFFFFFFF FFFFFFFF  
系数$a$：FFFFFFFE FFFFFFFF FFFFFFFF FFFFFFFF FFFFFFFF 00000000 FFFFFFFF FFFFFFFC  
系数$b$：28E9FA9E 9D9F5E34 4D5A9E4B CF6509A7 F39789F5 15AB8F92 DDBCBD41 4D940E93  
余因子(可选)：1  
对于基点$G=(x_G,y_G)$，其阶记为$n$  
$x_G$：32C4AE2C 1F198119 5F990446 6A39C994 8FE30BBF F2660BE1 715A4589 334C74C7  
$y_G$：BC3736A2 F4F6779C 59BDCEE3 6B692153 D0A9877C C62A4740 02DF32E5 2139F0A0  
$\ \ n$：FFFFFFFE FFFFFFFF FFFFFFFF FFFFFFFF 7203DF6B 21C6052B 53BBF409 39D54123

#### 密钥对生成\[签名\]

*这个函数是一个概念，已经融合在步骤中了
输入：一个有效的素域或扩域这个数必须是大于3的素数或2的m次方。  
输出：密钥对（d,P）  
1. 随机数发生器产生整数$d \in (1,n-2)$  
2. 计算点$P = (x_p,y_p) = [d]G$（倍点）  
3. 密钥对是（d,P），其中d为私钥，P为公钥。  
ps:这里的倍点运算存在快速运算方式，从0开始自己写可以用  

#### 用户其他信息($Z_A$)\[签名\]\[交换\]

输入：用户$IDa$，椭圆曲线参数$a、b、x_G、y_G$，用户公钥$x_A、y_A$  
输出：一个杂凑值  
就一个公式：  
$Z_A=H_{256}(ENTL_A||ID_A||a||b||x_G||y_G||x_A||y_A)$  
一个参数：$ENTL_A$是由 $ID_A$ 的比特长度 $entlen_A$ 转换成的两个字节

#### 密钥派生函数KDF\[交换\]\[加密\]

输入：共享秘密比特串$Z$，要获得密钥长度$klen$  
输出：输出$klen$长度的密钥数据比特串$K$  
作用：不写一下感觉不好理解了。作用是从一个共享秘密比特串中派生出密钥数据。  
1. 初始化32位计数器$ct$ = 0x00000001  
2. 对$i$从1到$klen/v$执行：($v$是杂凑函数输出位数)  
    1. $Ha_i = H_v(Z||ct)$  
    2. $ct++$  
3. 若klen/v是整数，令$Ha!_{\lceil klen/v \rceil}=Ha_{\lceil klen/v \rceil}$，否则令$Ha!_{\lceil klen/v \rceil}$为$Ha_{\lceil klen/v \rceil}$最左侧$(klen-(v*\lfloor klen/v \rfloor))$比特  
4. 令$K=Ha_1||Ha_2||…||Ha_{\lceil klen/v \rceil-1}||Ha!_{\lceil klen/v \rceil}$  
  
SM2另外涉及两种辅助算法：**密码杂凑函数、随机数生成函数**  
这两个的要求标准中均是：使用国家密码管理局批准的   
对于密码杂凑函数，标准中指明了“如SM3”    
至于随机数发生器，我在代码里偷懒了，用了MIRACL库自带的随机数发生器，实际上可以有多种实现方法的  

### 数字签名算法

签名算法包含在标准文件的第二章中

#### 签名

待签名消息$M$  
1. 首先是计算$\overline{M}=Z_A||M$；  
2. 计算$e=H_v(\overline{M})$，并将$e$转换为整数  
3. 生成随机数$k\in[1,n-1]$  
4. 计算椭圆曲线点$(x_1,y_1)=[k]G$，并将$x_1$转换为整数  
5. 计算$r=(e+x_1)mod\ n$，若$r=0$或$r+k=n$则返回 A3  
6. 计算$s=((1+d_A)^{-1}\cdot(k-r\cdot d_A))mod\ n$，若$s=0$则返回 A3  
7. 将$r、s$转换为字符串，输出签名$(r,s)$  

#### 验签

收到的消息$M^\prime$、其数字签名$(r^\prime,s^\prime)$  
1. 检验$r^\prime\in[1,n-1]$，不成立则不通过  
2. 检验$s^\prime\in[1,n-1]$，不成立则不通过  
3. 置$\overline{M}^\prime=Z_A||M^\prime$  
4. 计算$e^\prime=H_v(\overline{M}^\prime)$并将$e$转换为整数   
5. 将$r^\prime、s^\prime$转换为整数，计算$t=(r^\prime+s^\prime)mod\ n$，若$t=0$则不通过    
6. 计算椭圆曲线点$(x_1^\prime,y_1^\prime)=[s^\prime]G+[t]P_A$  
7. 将$x_1^\prime$转换为整数,计算$R=(e^\prime,x_1^\prime)mod\ n$，若$R=r^\prime$则验证成立，否则不成立  

### 密钥交换协议

密钥交换协议在标准文件第三章，是我的知识盲区（什么，公钥密码算法需要密钥交换？）先写着非对称看看，如果不用就先放放。

### 非对称密码算法

#### 加密过程

#### 解密过程
